<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Agent Trading Dashboard</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #0f0c29, #302b63, #24243e);
            color: #fff;
            min-height: 100vh;
            padding: 20px;
        }
        .container { max-width: 1400px; margin: 0 auto; }
        h1 {
            text-align: center;
            font-size: 2.5rem;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #00ff88, #00d4ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .subtitle { text-align: center; color: #aaa; margin-bottom: 40px; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 30px; }
        @media (max-width: 968px) { .grid { grid-template-columns: 1fr; } }
        .card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 25px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .card h2 { font-size: 1.5rem; margin-bottom: 15px; color: #00ff88; }
        textarea {
            width: 100%;
            min-height: 400px;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(0, 255, 136, 0.3);
            border-radius: 10px;
            padding: 15px;
            color: #fff;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            resize: vertical;
        }
        .output-section { grid-column: 1 / -1; }
        .output-box {
            background: rgba(0, 0, 0, 0.4);
            border: 2px solid #00ff88;
            border-radius: 10px;
            padding: 20px;
            min-height: 300px;
            max-height: 600px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.85rem;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .button-group { display: flex; gap: 15px; margin-top: 20px; flex-wrap: wrap; }
        button {
            flex: 1;
            min-width: 150px;
            padding: 15px 30px;
            font-size: 1rem;
            font-weight: bold;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            text-transform: uppercase;
        }
        .btn-generate { background: linear-gradient(45deg, #00ff88, #00d4ff); color: #000; }
        .btn-copy { background: linear-gradient(45deg, #667eea, #764ba2); color: #fff; }
        .btn-clear { background: linear-gradient(45deg, #f093fb, #f5576c); color: #fff; }
        .status {
            margin-top: 15px;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            font-weight: bold;
            display: none;
        }
        .status.success {
            background: rgba(0, 255, 136, 0.2);
            border: 1px solid #00ff88;
            color: #00ff88;
            display: block;
        }
        .status.error {
            background: rgba(255, 87, 108, 0.2);
            border: 1px solid #f5576c;
            color: #f5576c;
            display: block;
        }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        .stat-card { background: rgba(0, 0, 0, 0.3); padding: 15px; border-radius: 10px; border-left: 4px solid #00ff88; }
        .stat-label { font-size: 0.85rem; color: #aaa; margin-bottom: 5px; }
        .stat-value { font-size: 1.5rem; font-weight: bold; color: #00ff88; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ü§ñ Multi-Agent Trading Dashboard</h1>
        <p class="subtitle">KI-gest√ºtzte Aktienanalyse ‚Üí Pine Script Generator</p>

        <div class="grid">
            <div class="card">
                <h2>üìã JSON Input</h2>
                <textarea id="jsonInput" placeholder='F√ºge hier die komplette JSON-Ausgabe ein...'></textarea>
            </div>

            <div class="card">
                <h2>üìä Extrahierte Daten</h2>
                <div class="stats-grid">
                    <div class="stat-card"><div class="stat-label">Aktie</div><div class="stat-value" id="statStock">-</div></div>
                    <div class="stat-card"><div class="stat-label">Kurs</div><div class="stat-value" id="statPrice">-</div></div>
                    <div class="stat-card"><div class="stat-label">Score</div><div class="stat-value" id="statScore">-</div></div>
                    <div class="stat-card"><div class="stat-label">Setup</div><div class="stat-value" id="statSetup">-</div></div>
                    <div class="stat-card"><div class="stat-label">Entry</div><div class="stat-value" id="statEntry">-</div></div>
                    <div class="stat-card"><div class="stat-label">Stop Loss</div><div class="stat-value" id="statSL">-</div></div>
                    <div class="stat-card"><div class="stat-label">TP1</div><div class="stat-value" id="statTP1">-</div></div>
                    <div class="stat-card"><div class="stat-label">TP2</div><div class="stat-value" id="statTP2">-</div></div>
                </div>
            </div>
        </div>

        <div class="card output-section">
            <h2>‚ö° Generiertes Pine Script</h2>
            <div class="output-box" id="pineScriptOutput">// Dein Pine Script erscheint hier...</div>
            
            <div class="button-group">
                <button class="btn-generate" onclick="generatePineScript()">‚ö° Pine Script Generieren</button>
                <button class="btn-copy" onclick="copyToClipboard()">üìã Kopieren</button>
                <button class="btn-clear" onclick="clearAll()">üóëÔ∏è L√∂schen</button>
            </div>

            <div class="status" id="status"></div>
        </div>
    </div>

    <script>
        function showStatus(message, type) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = 'status ' + type;
            setTimeout(() => { status.className = 'status'; }, 5000);
        }

        function generatePineScript() {
            console.log('Generiere Pine Script...');
            const jsonInput = document.getElementById('jsonInput').value.trim();
            
            if (!jsonInput) {
                showStatus('‚ùå Bitte JSON-Daten einf√ºgen!', 'error');
                return;
            }

            try {
                let allData = {};
                
                // Finde alle JSON-Objekte im Text (auch wenn sie direkt hintereinander stehen)
                let depth = 0;
                let currentJson = '';
                let jsonObjects = [];
                
                for (let i = 0; i < jsonInput.length; i++) {
                    const char = jsonInput[i];
                    
                    if (char === '{') {
                        depth++;
                        currentJson += char;
                    } else if (char === '}') {
                        currentJson += char;
                        depth--;
                        
                        // Wenn wir ein komplettes Objekt haben
                        if (depth === 0 && currentJson.trim()) {
                            jsonObjects.push(currentJson.trim());
                            currentJson = '';
                        }
                    } else if (depth > 0) {
                        currentJson += char;
                    }
                }
                
                console.log(`Gefunden: ${jsonObjects.length} JSON-Objekte`);
                
                // Parse alle gefundenen JSON-Objekte
                for (let i = 0; i < jsonObjects.length; i++) {
                    try {
                        const parsed = JSON.parse(jsonObjects[i]);
                        const agentName = parsed.agent || `Block ${i+1}`;
                        console.log(`‚úì ${agentName} erfolgreich geparst`);
                        
                        // Merge Daten - sp√§ter Objekte √ºberschreiben fr√ºhere
                        allData = { ...allData, ...parsed };
                    } catch (e) {
                        console.warn(`‚úó Block ${i+1} fehlgeschlagen:`, e.message);
                    }
                }
                
                if (Object.keys(allData).length === 0) {
                    throw new Error('Keine g√ºltigen JSON-Daten gefunden');
                }
                
                console.log('Kombinierte Daten:', allData);
                const data = allData;
                
                // Daten extrahieren
                const stock = data.aktie || 'Unknown';
                const price = data.aktueller_kurs_eur || 414.91;
                const score = data.gesamtbewertung?.gewichteter_score || 70;
                const setup = data.setup_qualitaet || 'A';
                const entryLow = data.trading_empfehlung?.einstiegsstrategie?.akzeptabler_einstiegsbereich_eur?.von || 408;
                const entryHigh = data.trading_empfehlung?.einstiegsstrategie?.akzeptabler_einstiegsbereich_eur?.bis || 415;
                const stopLoss = data.trading_empfehlung?.stop_loss?.stop_loss_kurs_eur || 390;
                const tp1 = data.trading_empfehlung?.kursziele?.konservativ_eur || 430;
                const tp2 = data.trading_empfehlung?.kursziele?.realistisch_eur || 450;
                const support1 = data.support_resistance?.major_support?.[0]?.level || 408;
                const resistance1 = data.support_resistance?.major_resistance?.[0]?.level || 420;

                // Stats aktualisieren
                document.getElementById('statStock').textContent = stock;
                document.getElementById('statPrice').textContent = `‚Ç¨${price.toFixed(2)}`;
                document.getElementById('statScore').textContent = `${score}/100`;
                document.getElementById('statSetup').textContent = setup;
                document.getElementById('statEntry').textContent = `‚Ç¨${entryLow.toFixed(2)}-‚Ç¨${entryHigh.toFixed(2)}`;
                document.getElementById('statSL').textContent = `‚Ç¨${stopLoss.toFixed(2)}`;
                document.getElementById('statTP1').textContent = `‚Ç¨${tp1.toFixed(2)}`;
                document.getElementById('statTP2').textContent = `‚Ç¨${tp2.toFixed(2)}`;

                // Pine Script generieren
                const pineScript = `//@version=5
indicator("üéØ ${stock} Trading Signals", overlay=true, max_labels_count=50)

// Multi-Agent Score: ${score}/100 | Setup: ${setup}

showEntrySignals = input.bool(true, "üü¢ Kaufsignale", group="Anzeige")
showExitSignals = input.bool(true, "üî¥ Verkaufssignale", group="Anzeige")
showStopLoss = input.bool(true, "‚õî Stop Loss", group="Anzeige")
showTakeProfit = input.bool(true, "üéØ Take Profit", group="Anzeige")

// Trading Parameter
entryLow = input.float(${entryLow.toFixed(2)}, "Entry Low", group="Entry")
entryHigh = input.float(${entryHigh.toFixed(2)}, "Entry High", group="Entry")
stopLoss = input.float(${stopLoss.toFixed(2)}, "Stop Loss", group="Risk")
tp1 = input.float(${tp1.toFixed(2)}, "TP1", group="Targets")
tp2 = input.float(${tp2.toFixed(2)}, "TP2", group="Targets")
support1 = input.float(${support1.toFixed(2)}, "Support", group="Levels")
resistance1 = input.float(${resistance1.toFixed(2)}, "Resistance", group="Levels")

// Indikatoren
sma20 = ta.sma(close, 20)
sma50 = ta.sma(close, 50)
rsi = ta.rsi(close, 14)
atr = ta.atr(14)

inEntryZone = close >= entryLow and close <= entryHigh
avgEntry = (entryLow + entryHigh) / 2

bullishTrend = close > sma20 and sma20 > sma50
buySignal = inEntryZone and bullishTrend and not inEntryZone[1]

// Visualisierung
plot(sma20, "SMA 20", color.new(color.yellow, 60), 1)
plot(sma50, "SMA 50", color.new(color.orange, 60), 1)

if barstate.islast and showTakeProfit
    line.new(bar_index - 50, tp1, bar_index + 20, tp1, color=color.new(color.lime, 30), width=2)
    label.new(bar_index + 22, tp1, "üéØ TP1: " + str.tostring(tp1), style=label.style_label_left, color=color.new(color.lime, 30), textcolor=color.white)
    
    line.new(bar_index - 50, tp2, bar_index + 20, tp2, color=color.new(color.lime, 50), width=1)
    label.new(bar_index + 22, tp2, "üöÄ TP2: " + str.tostring(tp2), style=label.style_label_left, color=color.new(color.lime, 50), textcolor=color.white)

if barstate.islast and showStopLoss
    line.new(bar_index - 50, stopLoss, bar_index + 20, stopLoss, color=color.new(color.red, 20), width=3)
    label.new(bar_index + 22, stopLoss, "‚õî SL: " + str.tostring(stopLoss), style=label.style_label_left, color=color.new(color.red, 20), textcolor=color.white)

if barstate.islast and showEntrySignals
    box.new(bar_index - 30, entryLow, bar_index + 15, entryHigh, border_color=color.new(color.lime, 40), bgcolor=color.new(color.lime, 93), border_width=2)

if buySignal and showEntrySignals
    label.new(bar_index, low - atr * 0.5, "üü¢ KAUFEN\\n" + str.tostring(close), style=label.style_label_up, color=color.new(color.lime, 0), textcolor=color.black, size=size.large)

if ta.crossover(close, tp1) and showExitSignals
    label.new(bar_index, high + atr * 0.5, "üéØ TP1\\n" + str.tostring(close), style=label.style_label_down, color=color.new(color.lime, 0), textcolor=color.black, size=size.large)

if ta.crossunder(close, stopLoss)
    label.new(bar_index, low - atr * 0.5, "‚õî STOP\\n" + str.tostring(close), style=label.style_label_up, color=color.new(color.red, 0), textcolor=color.white, size=size.huge)

// Dashboard
var table dashboard = table.new(position.top_left, 2, 6, bgcolor=color.new(color.black, 5))

if barstate.islast
    table.cell(dashboard, 0, 0, "ü§ñ ${stock}", bgcolor=color.new(color.lime, 60), text_color=color.white)
    table.merge_cells(dashboard, 0, 0, 1, 0)
    
    table.cell(dashboard, 0, 1, "Entry:", text_color=color.white)
    table.cell(dashboard, 1, 1, str.tostring(avgEntry), text_color=color.yellow)
    
    table.cell(dashboard, 0, 2, "Stop Loss:", text_color=color.white)
    table.cell(dashboard, 1, 2, str.tostring(stopLoss), text_color=color.red)
    
    table.cell(dashboard, 0, 3, "TP1:", text_color=color.white)
    table.cell(dashboard, 1, 3, str.tostring(tp1), text_color=color.lime)

alertcondition(buySignal, "KAUFEN", "Entry Zone erreicht!")
alertcondition(ta.crossover(close, tp1), "TP1", "Take Profit 1!")
alertcondition(ta.crossunder(close, stopLoss), "STOP LOSS", "Stop Loss Hit!")`;

                document.getElementById('pineScriptOutput').textContent = pineScript;
                showStatus('‚úÖ Pine Script erfolgreich generiert!', 'success');
                
            } catch (e) {
                console.error('Fehler:', e);
                showStatus('‚ùå Fehler beim Parsen: ' + e.message, 'error');
            }
        }

        function copyToClipboard() {
            const output = document.getElementById('pineScriptOutput').textContent;
            if (output === '// Dein Pine Script erscheint hier...') {
                showStatus('‚ùå Bitte erst Pine Script generieren!', 'error');
                return;
            }
            navigator.clipboard.writeText(output).then(() => {
                showStatus('‚úÖ Pine Script kopiert!', 'success');
            });
        }

        function clearAll() {
            document.getElementById('jsonInput').value = '';
            document.getElementById('pineScriptOutput').textContent = '// Dein Pine Script erscheint hier...';
            document.getElementById('status').className = 'status';
            ['statStock', 'statPrice', 'statScore', 'statSetup', 'statEntry', 'statSL', 'statTP1', 'statTP2'].forEach(id => {
                document.getElementById(id).textContent = '-';
            });
        }
    </script>
</body>
</html>
