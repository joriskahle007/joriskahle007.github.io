//@version=5
indicator("Swing Trading Pro - Pattern & Zonen", overlay=true, max_bars_back=5000, max_lines_count=500, max_labels_count=500)

// === EINGABEPARAMETER ===
prognoseStunden = input.float(3.0, "Prognose-Zeitraum (Stunden)", minval=0.5, maxval=24.0, step=0.5)
patternLaenge = input.int(20, "Pattern-L√§nge f√ºr Matching", minval=10, maxval=50)
suchTiefe = input.int(2000, "Historische Such-Tiefe (Balken)", minval=500, maxval=5000)
anzahlBestenMatches = input.int(20, "Anzahl bester Pattern-Matches", minval=10, maxval=50)

// === NEWS-SENTIMENT PARAMETER ===
newsSentimentScore = input.int(80, "üì∞ News-Sentiment Score", minval=-100, maxval=100)
newsAdjustmentBeste = input.float(5.2, "News-Anpassung Beste Prognose (%)", minval=-50, maxval=50, step=0.5)
newsAdjustmentWahrscheinlichste = input.float(3.4, "News-Anpassung Wahrscheinlichste (%)", minval=-50, maxval=50, step=0.5)
newsAdjustmentSchlechteste = input.float(-2.1, "News-Anpassung Schlechteste (%)", minval=-50, maxval=50, step=0.5)
newsAdjustmentWahrscheinlichkeit = input.float(8.0, "News-Anpassung Wahrscheinlichkeit (%)", minval=-50, maxval=50, step=0.5)
useNewsAdjustment = input.bool(true, "‚úÖ News-Sentiment aktivieren")

// === SWING TRADING PARAMETER ===
swingMinBars = input.int(10, "Min. Balken zwischen Signalen", minval=5, maxval=50, tooltip="Verhindert zu h√§ufige Signale")
risikoAbstand = input.float(4.1, "Stop-Loss Abstand (%)", minval=0.5, maxval=10.0)
gewinnZiel1 = input.float(3.8, "Take-Profit 1 (%)", minval=1.0, maxval=20.0)
gewinnZiel2 = input.float(8.0, "Take-Profit 2 (%)", minval=5.0, maxval=30.0)
showZones = input.bool(true, "üìä Zonen anzeigen", tooltip="Zeigt TP/SL Zonen grafisch")

// === KERZENMUSTER ERKENNUNG ===
showPatterns = input.bool(true, "üïØÔ∏è Kerzenmuster anzeigen")

// === BASIS-INDIKATOREN ===
sma20 = ta.sma(close, 20)
sma50 = ta.sma(close, 50)
sma200 = ta.sma(close, 200)
rsi = ta.rsi(close, 14)
[macdLine, signalLine, macdHist] = ta.macd(close, 12, 26, 9)
[diPlus, diMinus, adx] = ta.dmi(14, 14)
atr = ta.atr(14)
volume_sma = ta.sma(volume, 20)

// Trend-St√§rke
trend = (close > sma20 ? 1 : -1) + (macdLine > signalLine ? 1 : -1) + (rsi > 50 ? 1 : -1)
trendStaerke = trend / 3

// === KERZENMUSTER FUNKTIONEN ===

// Bullish Engulfing
bullishEngulfing = close[1] < open[1] and close > open and 
                   open <= close[1] and close >= open[1] and
                   close - open > open[1] - close[1]

// Bearish Engulfing
bearishEngulfing = close[1] > open[1] and close < open and 
                   open >= close[1] and close <= open[1] and
                   open - close > close[1] - open[1]

// Hammer (Bullish)
bodySize = math.abs(close - open)
upperWick = high - math.max(close, open)
lowerWick = math.min(close, open) - low
hammer = lowerWick > bodySize * 2 and upperWick < bodySize and close > open and low == ta.lowest(low, 5)

// Shooting Star (Bearish)
shootingStar = upperWick > bodySize * 2 and lowerWick < bodySize and close < open and high == ta.highest(high, 5)

// Doji
doji = bodySize < (high - low) * 0.1 and bodySize > 0

// Morning Star (3-Kerzen Bullish)
morningStar = close[2] < open[2] and 
              math.abs(close[1] - open[1]) < bodySize[2] * 0.3 and
              close > open and close > (open[2] + close[2]) / 2

// Evening Star (3-Kerzen Bearish)
eveningStar = close[2] > open[2] and 
              math.abs(close[1] - open[1]) < bodySize[2] * 0.3 and
              close < open and close < (open[2] + close[2]) / 2

// Higher High / Higher Low (Uptrend)
higherHigh = high > high[1] and high[1] > high[2] and low > low[1]
higherLow = low > low[1] and low[1] > low[2] and high > high[1]

// Lower High / Lower Low (Downtrend)
lowerHigh = high < high[1] and high[1] < high[2] and low < low[1]
lowerLow = low < low[1] and low[1] < low[2] and high < high[1]

// === PATTERN VISUALISIERUNG ===
if showPatterns
    // Bullish Patterns
    if bullishEngulfing
        label.new(bar_index, low, "BE", style=label.style_label_up, color=color.new(color.green, 20), textcolor=color.white, size=size.small, tooltip="Bullish Engulfing")
    
    if hammer
        label.new(bar_index, low, "H", style=label.style_label_up, color=color.new(color.lime, 30), textcolor=color.black, size=size.small, tooltip="Hammer")
    
    if morningStar
        label.new(bar_index, low, "MS", style=label.style_label_up, color=color.new(color.green, 10), textcolor=color.white, size=size.normal, tooltip="Morning Star")
    
    if higherHigh
        label.new(bar_index, high, "HH", style=label.style_label_down, color=color.new(color.yellow, 30), textcolor=color.black, size=size.tiny, tooltip="Higher High")
    
    if higherLow
        label.new(bar_index, low, "HL", style=label.style_label_up, color=color.new(color.yellow, 30), textcolor=color.black, size=size.tiny, tooltip="Higher Low")
    
    // Bearish Patterns
    if bearishEngulfing
        label.new(bar_index, high, "BE", style=label.style_label_down, color=color.new(color.red, 20), textcolor=color.white, size=size.small, tooltip="Bearish Engulfing")
    
    if shootingStar
        label.new(bar_index, high, "SS", style=label.style_label_down, color=color.new(color.orange, 30), textcolor=color.white, size=size.small, tooltip="Shooting Star")
    
    if eveningStar
        label.new(bar_index, high, "ES", style=label.style_label_down, color=color.new(color.red, 10), textcolor=color.white, size=size.normal, tooltip="Evening Star")
    
    if lowerHigh
        label.new(bar_index, high, "LH", style=label.style_label_down, color=color.new(color.orange, 30), textcolor=color.black, size=size.tiny, tooltip="Lower High")
    
    if lowerLow
        label.new(bar_index, low, "LL", style=label.style_label_up, color=color.new(color.orange, 30), textcolor=color.black, size=size.tiny, tooltip="Lower Low")
    
    // Neutral
    if doji
        label.new(bar_index, high, "D", style=label.style_label_down, color=color.new(color.gray, 50), textcolor=color.white, size=size.tiny, tooltip="Doji")

// === SWING TRADING SIGNALE (VERBESSERT) ===
var int barsSinceLastSignal = 0
barsSinceLastSignal := barsSinceLastSignal + 1

// St√§rkere Bedingungen f√ºr Swing Trading
strongUptrend = close > sma20 and sma20 > sma50 and close > sma50
strongDowntrend = close < sma20 and sma20 < sma50 and close < sma50

// LONG Signal (nur bei starken Bedingungen)
longCondition = strongUptrend and 
                rsi > 45 and rsi < 65 and 
                macdHist > 0 and macdHist > macdHist[1] and
                volume > volume_sma * 1.1 and
                adx > 25 and
                (bullishEngulfing or hammer or morningStar or (higherHigh and higherLow)) and
                barsSinceLastSignal >= swingMinBars

// SHORT Signal (nur bei starken Bedingungen)
shortCondition = strongDowntrend and 
                 rsi < 55 and rsi > 35 and 
                 macdHist < 0 and macdHist < macdHist[1] and
                 volume > volume_sma * 1.1 and
                 adx > 25 and
                 (bearishEngulfing or shootingStar or eveningStar or (lowerHigh and lowerLow)) and
                 barsSinceLastSignal >= swingMinBars

longSignal = longCondition and not longCondition[1]
shortSignal = shortCondition and not shortCondition[1]

if longSignal or shortSignal
    barsSinceLastSignal := 0

// Exit Bedingungen (weniger aggressiv)
longExit = (close < sma20 or rsi > 80 or macdLine < signalLine) and longCondition[1]
shortExit = (close > sma20 or rsi < 20 or macdLine > signalLine) and shortCondition[1]

// === SIGNAL VISUALISIERUNG ===
plotshape(longSignal, "LONG Entry", shape.triangleup, location.belowbar, color.new(color.green, 0), size=size.large, text="LONG\nBUY")
plotshape(shortSignal, "SHORT Entry", shape.triangledown, location.abovebar, color.new(color.red, 0), size=size.large, text="SHORT\nSELL")
plotshape(longExit, "LONG Exit", shape.circle, location.abovebar, color.new(color.green, 70), size=size.small, text="Exit")
plotshape(shortExit, "SHORT Exit", shape.circle, location.belowbar, color.new(color.red, 70), size=size.small, text="Exit")

// === ZONEN F√úR TP/SL ===
var box longTPBox1 = na
var box longTPBox2 = na
var box longSLBox = na
var box shortTPBox1 = na
var box shortTPBox2 = na
var box shortSLBox = na

var line longEntryLine = na
var line shortEntryLine = na

if showZones
    // LONG Zonen
    if longSignal
        // Alte Boxen l√∂schen
        if not na(longTPBox1)
            box.delete(longTPBox1)
            box.delete(longTPBox2)
            box.delete(longSLBox)
            line.delete(longEntryLine)
        
        entryPrice = close
        tp1 = entryPrice * (1 + gewinnZiel1/100)
        tp2 = entryPrice * (1 + gewinnZiel2/100)
        sl = entryPrice * (1 - risikoAbstand/100)
        
        // Entry Line
        longEntryLine := line.new(bar_index, entryPrice, bar_index + 50, entryPrice, color=color.new(color.blue, 0), width=2, style=line.style_dashed)
        
        // TP Zonen (gr√ºn)
        longTPBox1 := box.new(bar_index, entryPrice, bar_index + 50, tp1, 
                              border_color=color.new(color.green, 50), 
                              bgcolor=color.new(color.green, 90),
                              text="TP1: " + str.tostring(gewinnZiel1, "#.#") + "%",
                              text_color=color.green,
                              text_size=size.small)
        
        longTPBox2 := box.new(bar_index, tp1, bar_index + 50, tp2, 
                              border_color=color.new(color.green, 30), 
                              bgcolor=color.new(color.green, 95),
                              text="TP2: " + str.tostring(gewinnZiel2, "#.#") + "%",
                              text_color=color.green,
                              text_size=size.small)
        
        // SL Zone (rot)
        longSLBox := box.new(bar_index, entryPrice, bar_index + 50, sl, 
                             border_color=color.new(color.red, 50), 
                             bgcolor=color.new(color.red, 90),
                             text="SL: -" + str.tostring(risikoAbstand, "#.#") + "%",
                             text_color=color.red,
                             text_size=size.small)
    
    // SHORT Zonen
    if shortSignal
        // Alte Boxen l√∂schen
        if not na(shortTPBox1)
            box.delete(shortTPBox1)
            box.delete(shortTPBox2)
            box.delete(shortSLBox)
            line.delete(shortEntryLine)
        
        entryPrice = close
        tp1 = entryPrice * (1 - gewinnZiel1/100)
        tp2 = entryPrice * (1 - gewinnZiel2/100)
        sl = entryPrice * (1 + risikoAbstand/100)
        
        // Entry Line
        shortEntryLine := line.new(bar_index, entryPrice, bar_index + 50, entryPrice, color=color.new(color.blue, 0), width=2, style=line.style_dashed)
        
        // TP Zonen (gr√ºn)
        shortTPBox1 := box.new(bar_index, entryPrice, bar_index + 50, tp1, 
                               border_color=color.new(color.green, 50), 
                               bgcolor=color.new(color.green, 90),
                               text="TP1: " + str.tostring(gewinnZiel1, "#.#") + "%",
                               text_color=color.green,
                               text_size=size.small)
        
        shortTPBox2 := box.new(bar_index, tp1, bar_index + 50, tp2, 
                               border_color=color.new(color.green, 30), 
                               bgcolor=color.new(color.green, 95),
                               text="TP2: " + str.tostring(gewinnZiel2, "#.#") + "%",
                               text_color=color.green,
                               text_size=size.small)
        
        // SL Zone (rot)
        shortSLBox := box.new(bar_index, entryPrice, bar_index + 50, sl, 
                              border_color=color.new(color.red, 50), 
                              bgcolor=color.new(color.red, 90),
                              text="SL: -" + str.tostring(risikoAbstand, "#.#") + "%",
                              text_color=color.red,
                              text_size=size.small)
    
    // Zonen erweitern
    if not na(longTPBox1) and not longExit
        box.set_right(longTPBox1, bar_index + 50)
        box.set_right(longTPBox2, bar_index + 50)
        box.set_right(longSLBox, bar_index + 50)
        line.set_x2(longEntryLine, bar_index + 50)
    
    if not na(shortTPBox1) and not shortExit
        box.set_right(shortTPBox1, bar_index + 50)
        box.set_right(shortTPBox2, bar_index + 50)
        box.set_right(shortSLBox, bar_index + 50)
        line.set_x2(shortEntryLine, bar_index + 50)
    
    // Zonen l√∂schen bei Exit
    if longExit and not na(longTPBox1)
        box.delete(longTPBox1)
        box.delete(longTPBox2)
        box.delete(longSLBox)
        line.delete(longEntryLine)
    
    if shortExit and not na(shortTPBox1)
        box.delete(shortTPBox1)
        box.delete(shortTPBox2)
        box.delete(shortSLBox)
        line.delete(shortEntryLine)

// === TRENDLINIEN ===
plot(sma20, "SMA 20", color=color.new(color.blue, 30), linewidth=2)
plot(sma50, "SMA 50", color=color.new(color.orange, 30), linewidth=2)
plot(sma200, "SMA 200", color=color.new(color.purple, 50), linewidth=1)

// === PROGNOSELINIEN (Original-Code bleibt bestehen) ===
// [Hier w√ºrde der Rest deines Original-Pattern-Matching-Codes folgen]
